[{"id":"6048f8e.4a8a188","type":"tab","label":"ShelfStatusUpdate","disabled":false,"info":"Receives shelf status update, and if it needs restock sends an action to staff"},{"id":"ff8dca5f.92dd4","type":"tab","label":"StaffPalmarsActionCompletion","disabled":false,"info":"Handles \"action complete\" notifications from staff palmars"},{"id":"cdaf015f.da6f9","type":"tab","label":"ClientHelpRequest","disabled":false,"info":"Receive client help request and send notification \nto staff"},{"id":"b990c6b5.7066a8","type":"tab","label":"TCPRequestsServer","disabled":false,"info":"Handles information requests via tcp"},{"id":"ccf231bf.81e27","type":"tab","label":"ClientPutsProductInCart","disabled":false,"info":"receives an event when the client puts a product in \nthe cart and sends him a notification"},{"id":"fe000750.43aec8","type":"tab","label":"ClientRemovesProductFromCart","disabled":false,"info":"Receives a message from carts when a product is \nremoved from them and notifies the relative client"},{"id":"e79ea024.5ddb1","type":"tab","label":"ProcessPayment","disabled":false,"info":"TCP internal server that receives encrypted \npayment request and processes authorization"},{"id":"8814dea3.14c64","type":"tab","label":"ClientSendsRating","disabled":false,"info":"Receives client rating, saves it to db and \nupdates dashboard"},{"id":"ad459c75.a2d28","type":"tab","label":"Dashboard","disabled":false,"info":"Fetches and displays data from the market"},{"id":"7aa22b9c.ee2e24","type":"subflow","name":"GetClientAllergies","info":"Get client allegies with idx","in":[{"x":60,"y":40,"wires":[{"id":"ba8cd76e.17e718"}]}],"out":[{"x":680,"y":40,"wires":[{"id":"296efa8e.1979c6","port":0}]}]},{"id":"d1064383.99592","type":"subflow","name":"req_GetProductInformation","info":"Get product information with idx","in":[{"x":40,"y":30,"wires":[{"id":"d031518d.b5175"}]}],"out":[{"x":1160,"y":40,"wires":[{"id":"ba58e9de.83e388","port":0}]}]},{"id":"89d4ce43.452ce8","type":"subflow","name":"req_GetCartTotal","info":"Get cart summary and total","in":[{"x":60,"y":40,"wires":[{"id":"1bd1ca5d.32251e"}]}],"out":[{"x":1260,"y":60,"wires":[{"id":"389d13a5.9e12f4","port":0}]}]},{"id":"fd41aaa7.f153","type":"subflow","name":"CheckAllergies","info":"Given a list of allergenes and a clientIdx, checks \ncompatibility and returns a list of warnings \nfor the client","in":[{"x":50,"y":30,"wires":[{"id":"b8850717.41e658"}]}],"out":[{"x":1040,"y":40,"wires":[{"id":"fd14dd4.21a5b2","port":0}]}]},{"id":"9795499c.56c298","type":"subflow","name":"req_ClientPaymentRequest","info":"Handles client payment requests","in":[{"x":50,"y":30,"wires":[{"id":"837af942.a504d8"}]}],"out":[{"x":1180,"y":460,"wires":[{"id":"9eb5fe86.2c41a8","port":0},{"id":"885b1109.8994c8","port":0}]}]},{"id":"98cc4982.4a2d68","type":"subflow","name":"SendPurchaseEmailToClient","info":"Receives purchase data and sends email to client","in":[{"x":50,"y":30,"wires":[{"id":"4d59a591.b8ee1c"}]}],"out":[]},{"id":"2e7efc7b.baa364","type":"subflow","name":"SavePurchase","info":"Receives purchase data and saves it on db","in":[{"x":50,"y":30,"wires":[{"id":"f0de4e67.789f7"}]}],"out":[]},{"id":"73e3c04c.e444","type":"subflow","name":"RequestRatingToClient","info":"Sends the client a request for a rating","in":[{"x":50,"y":30,"wires":[{"id":"85782836.13b7a"}]}],"out":[]},{"id":"809e0a56.47445","type":"subflow","name":"req_ClientProductInformationRequest","info":"Receives a product information \nrequest from a client, handling the product \ncompatibility check","in":[{"x":50,"y":30,"wires":[{"id":"4354d30e.6db97c"}]}],"out":[{"x":1260,"y":40,"wires":[{"id":"dba6fce0.71ea88","port":0}]}]},{"id":"4b78a9ba.a4721","type":"subflow","name":"req_GetClientInformation","info":"given a client idx, returns all client data","in":[{"x":50,"y":30,"wires":[{"id":"718ec499.f6b9ac"}]}],"out":[{"x":660,"y":40,"wires":[{"id":"86d35ade.029c38","port":0}]}]},{"id":"31a2f90.b455288","type":"subflow","name":"VerifyClientSignature","info":"given a clientIdx and signature, verifies the \nsignature with client's public key","in":[{"x":50,"y":30,"wires":[{"id":"ba9bd4b2.dd9f3"}]}],"out":[{"x":1120,"y":40,"wires":[{"id":"f6c3cd9e.926d8","port":0}]}]},{"id":"2f173c3d.2232a4","type":"mqtt-broker","z":"","name":"LocalMQTTBroker","broker":"localhost","port":"1883","tls":"","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"b1b3643e.1e1e58","type":"mongodb2","z":"","uri":"mongodb://localhost:27017/MarketGo","name":"MarketGo","options":"","parallelism":"-1"},{"id":"ee0e73f1.349f18","type":"ui_tab","z":"","name":"MarketGo","icon":"dashboard"},{"id":"98a7c04b.8378e8","type":"ui_group","z":"","name":"Shelves","tab":"ee0e73f1.349f18","disp":true,"width":"5","collapse":false},{"id":"f4b58747.046d58","type":"ui_group","z":"","name":"Inputs","tab":"","order":1,"disp":true,"width":"6"},{"id":"f42ddb9b.814cf","type":"ui_base","theme":{"name":"theme-custom","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#30499c","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","reset":false},"themeState":{"base-color":{"default":"#4B7930","value":"#30499c","edited":true},"page-titlebar-backgroundColor":{"value":"#30499c","edited":false},"page-backgroundColor":{"value":"#d7d7d7","edited":true},"page-sidebar-backgroundColor":{"value":"#000000","edited":false},"group-textColor":{"value":"#506cc9","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":true},"widget-textColor":{"value":"#5c5c5c","edited":true},"widget-backgroundColor":{"value":"#30499c","edited":false},"widget-borderColor":{"value":"#ffffff","edited":true},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"b3f7624a.893288","type":"ui_group","z":"","name":"Staff actions","tab":"ee0e73f1.349f18","disp":true,"width":"6","collapse":false},{"id":"8f6f8cca.3f0298","type":"ui_group","z":"","name":"Inputs","tab":"","order":1,"disp":true,"width":"6"},{"id":"698ffe32.b8c6e8","type":"ui_group","z":"","name":"Charts","tab":"","order":2,"disp":false,"width":"6"},{"id":"646c421b.36d5f4","type":"ui_group","z":"","name":"Inputs","tab":"","order":1,"disp":false,"width":"6"},{"id":"f1f785cd.18412","type":"ui_group","z":"","name":"Group 3","tab":"","order":3,"disp":false,"width":"6"},{"id":"ccd9dbca.72ce08","type":"ui_group","z":"","name":"Charts","tab":"","order":2,"disp":false,"width":"6"},{"id":"c1a911f7.651df8","type":"ui_group","z":"","name":"Inputs","tab":"","order":1,"disp":false,"width":"6"},{"id":"eb3084d.5ca4bf8","type":"ui_group","z":"","name":"Group 3","tab":"","order":3,"disp":false,"width":"6"},{"id":"9a679301.d6e728","type":"ui_group","z":"","name":"Charts","tab":"","order":2,"disp":false,"width":"6"},{"id":"3920fe7b.8d635a","type":"ui_group","z":"","name":"Inputs","tab":"","order":1,"disp":false,"width":"6"},{"id":"1e61f511.194d43","type":"ui_group","z":"","name":"Group 3","tab":"","order":3,"disp":false,"width":"6"},{"id":"db0547ff.0f651","type":"ui_group","z":"","name":"Charts","tab":"","order":2,"disp":false,"width":"6"},{"id":"116e134e.a8b925","type":"ui_group","z":"","name":"Inputs","tab":"","order":1,"disp":false,"width":"6"},{"id":"39687d71.a73152","type":"ui_group","z":"","name":"Group 3","tab":"","order":3,"disp":false,"width":"6"},{"id":"cba27512.52587","type":"ui_group","z":"","name":"Products sales","tab":"ee0e73f1.349f18","disp":true,"width":"8","collapse":false},{"id":"e415fc70.728728","type":"ui_group","z":"","name":"Charts","tab":"","order":2,"disp":false,"width":"6"},{"id":"a5a725fc.99d948","type":"ui_group","z":"","name":"Inputs","tab":"","order":1,"disp":false,"width":"6"},{"id":"c74921e1.8dc8b","type":"ui_group","z":"","name":"Group 3","tab":"","order":3,"disp":false,"width":"6"},{"id":"3b1f13e9.1b6c14","type":"ui_group","z":"","name":"Status","tab":"eb2fe35b.b559e8","order":1,"disp":true,"width":"6"},{"id":"eb2fe35b.b559e8","type":"ui_tab","z":"","name":"Testing","icon":"dashboard","order":3},{"id":"f05cf87c.417ef","type":"ui_group","z":"","name":"Clients ratings","tab":"ee0e73f1.349f18","disp":true,"width":"6","collapse":false},{"id":"5333b9a7.c954c","type":"json","z":"6048f8e.4a8a188","name":"ParseJSON","property":"payload","action":"","pretty":false,"x":230,"y":100,"wires":[["371b506b.e5971"]]},{"id":"bef6a133.e58398","type":"switch","z":"6048f8e.4a8a188","name":"CheckQuantityIsEnough","property":"actualQuantity","propertyType":"msg","rules":[{"t":"lt","v":"payload.minimumQuantity","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":890,"y":380,"wires":[["54da7586.1da9e4"]]},{"id":"371b506b.e5971","type":"function","z":"6048f8e.4a8a188","name":"SetContextAndPrepareQuery","func":"msg.actualQuantity = msg.payload.quantity;\nmsg.oldQuantity = msg.payload.oldQuantity;\n\nmsg.payload = [\n    {\n        idx: msg.payload.idx\n    },\n    {\n        _id: 0,\n        idx: 1,\n        minimumQuantity: 1\n    }\n]\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":160,"wires":[["de33e5a.25e8b98"]]},{"id":"de33e5a.25e8b98","type":"mongodb2 in","z":"6048f8e.4a8a188","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"GetShelfData","collection":"shelves","operation":"findOne","x":540,"y":220,"wires":[["9d8cd9fc.96ef78","7685d062.0bc168"]]},{"id":"54da7586.1da9e4","type":"function","z":"6048f8e.4a8a188","name":"CreateStaffAction","func":"var staffMsg = 'Restock shelf (idx: ' + \n        msg.payload.idx + ')';\n\nmsg.payload = {\n    type: 'restock',\n    message: staffMsg,\n    shelfIdx: msg.payload.idx\n}\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":440,"wires":[["b0e325ef.14d0b"]]},{"id":"fcf4d94c.8f9d2","type":"mqtt in","z":"ff8dca5f.92dd4","name":"ReceiveStaffAction","topic":"MarketGo/staff/action/completed","qos":"2","broker":"2f173c3d.2232a4","x":130,"y":60,"wires":[["f8eae27.c7db9a"]]},{"id":"f8eae27.c7db9a","type":"json","z":"ff8dca5f.92dd4","name":"ParseJSON","property":"payload","action":"","pretty":false,"x":290,"y":120,"wires":[["d1117120.1b4998"]]},{"id":"d1117120.1b4998","type":"function","z":"ff8dca5f.92dd4","name":"StoreCompletedActionQuery","func":"var action = msg.payload.action;\n\nflow.set('staffPalmarIdx', msg.payload.idx);\nflow.set('action', action);\n\nvar newActionRecord = Object.assign(\n    {date: new Date()}, action\n);\n\ndelete newActionRecord.message;\n    \nmsg.payload = [\n    { idx: msg.payload.idx },\n    { $push: { \n        completedActions: \n            newActionRecord\n        }\n    }\n];\n\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":180,"wires":[["58d969ef.83428"]]},{"id":"58d969ef.83428","type":"mongodb2 in","z":"ff8dca5f.92dd4","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"StoreAction","collection":"employees","operation":"update","x":690,"y":240,"wires":[["3ef8354a.a39a2a","4259c4d3.9cf18c"]]},{"id":"3ef8354a.a39a2a","type":"function","z":"ff8dca5f.92dd4","name":"PrepareDeleteActionMsg","func":"msg.payload = {\n    notification: flow.get('action')\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":300,"wires":[["9cf4ada.264b2d"]]},{"id":"9cf4ada.264b2d","type":"mqtt out","z":"ff8dca5f.92dd4","name":"UpdateStaffPalmars","topic":"MarketGo/staff/deleteAction","qos":"2","retain":"","broker":"2f173c3d.2232a4","x":1080,"y":360,"wires":[]},{"id":"dd01cc13.7ae468","type":"mqtt in","z":"cdaf015f.da6f9","name":"ReceiveClientHelpRequest","topic":"MarketGo/client/action/help","qos":"2","broker":"2f173c3d.2232a4","x":190,"y":80,"wires":[["d1eb1a85.8fce2"]]},{"id":"d1eb1a85.8fce2","type":"json","z":"cdaf015f.da6f9","name":"ParseJSON","property":"payload","action":"","pretty":false,"x":350,"y":160,"wires":[["8a8d941d.491c68"]]},{"id":"8a8d941d.491c68","type":"function","z":"cdaf015f.da6f9","name":"CreateStaffAction","func":"var clientName = msg.payload.name;\nvar clientIdx = msg.payload.idx;\n\nmsg.payload = {\n    type: 'help_client',\n    message: 'Help client ' + clientName + \n        ' (idx: ' + clientIdx + ')',\n    clientIdx: clientIdx\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":240,"wires":[["c0268d1f.3bac48"]]},{"id":"ba8cd76e.17e718","type":"function","z":"7aa22b9c.ee2e24","name":"PrepareQuery","func":"var clientIdx = msg.payload.idx;\n\nmsg.payload = [\n    {\n        idx: clientIdx\n    },\n    {\n        _id: 0,\n        allergies: 1\n    }\n];\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":60,"wires":[["296efa8e.1979c6"]]},{"id":"296efa8e.1979c6","type":"mongodb2 in","z":"7aa22b9c.ee2e24","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"GetClientAllergies","collection":"clients","operation":"findOne","x":490,"y":60,"wires":[[]]},{"id":"e0223fa6.846358","type":"switch","z":"d1064383.99592","name":"CheckMultipleRequested","property":"payload.multiple","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":160,"wires":[["bb44e0ac.45e6c8"],["ed69236.3e4abe"]]},{"id":"bb44e0ac.45e6c8","type":"function","z":"d1064383.99592","name":"PrepareMultipleFindQuery","func":"var productIdxs = \n    msg.payload.idx.map((el) =>\n        ({idx: el})\n    );\n\nmsg.operation = 'find.toArray';\n\nmsg.payload = [\n    {\n        $or: productIdxs\n    },\n    {\n        _id: 0\n    }\n];\n\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":100,"wires":[["e0741fbb.e0b188"]]},{"id":"ed69236.3e4abe","type":"function","z":"d1064383.99592","name":"PrepareSingleFindQuery","func":"msg.operation = 'findOne';\nmsg.payload = [\n    {\n        idx: msg.payload.idx\n    },\n    {\n        _id: 0\n    }\n];\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":220,"wires":[["e0741fbb.e0b188"]]},{"id":"e0741fbb.e0b188","type":"mongodb2 in","z":"d1064383.99592","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"FindProducts","collection":"products","operation":"","x":780,"y":160,"wires":[["ba58e9de.83e388"]]},{"id":"7e8ef659.326a4","type":"tcp in","z":"b990c6b5.7066a8","name":"ReceiveTCPRequest","server":"server","host":"","port":"1338","datamode":"stream","datatype":"utf8","newline":"\\n","topic":"","base64":false,"x":120,"y":40,"wires":[["90d79e98.6880d8"]]},{"id":"90d79e98.6880d8","type":"json","z":"b990c6b5.7066a8","name":"ParseJSON","property":"payload","action":"","pretty":false,"x":230,"y":100,"wires":[["e53c9e1a.ffb7b8"]]},{"id":"e53c9e1a.ffb7b8","type":"function","z":"b990c6b5.7066a8","name":"SetContextAndExtractMessage","func":"msg.responseIdx = msg.payload.responseIdx;\nmsg.clientIdx = msg.payload.clientIdx;\nmsg.payload = msg.payload.message;\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":160,"wires":[["73aabe71.9ef33"]]},{"id":"20ca43cd.024e74","type":"function","z":"b990c6b5.7066a8","name":"WrapWithResponseIdx","func":"msg.payload = {\n    responseIdx: msg.responseIdx,\n    message: msg.payload\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":240,"wires":[["313a1789.687c38"]]},{"id":"ac0f0549.0d7be","type":"tcp out","z":"b990c6b5.7066a8","host":"","port":"","beserver":"reply","base64":false,"end":false,"name":"SendInformation","x":1210,"y":420,"wires":[]},{"id":"73aabe71.9ef33","type":"switch","z":"b990c6b5.7066a8","name":"CheckRequestType","property":"payload.event","propertyType":"msg","rules":[{"t":"eq","v":"productInformationRequest","vt":"str"},{"t":"eq","v":"clientProductInformationRequest","vt":"str"},{"t":"eq","v":"cartTotalRequest","vt":"str"},{"t":"eq","v":"paymentRequest","vt":"str"},{"t":"eq","v":"clientInformationRequest","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":460,"y":240,"wires":[["ae580727.553468"],["31c081f.70914fe"],["aba3b89b.fca0c"],["6b16bc2f.5db2fc"],["451fddcd.9e016c"]]},{"id":"ae580727.553468","type":"subflow:d1064383.99592","z":"b990c6b5.7066a8","name":"","x":730,"y":120,"wires":[["20ca43cd.024e74"]]},{"id":"c5abe056.543a88","type":"mqtt in","z":"ccf231bf.81e27","name":"ReceiveProductAddedEvent","topic":"MarketGo/carts/productAdded","qos":"2","broker":"2f173c3d.2232a4","x":140,"y":40,"wires":[["27416cd6.80e3ac"]]},{"id":"27416cd6.80e3ac","type":"json","z":"ccf231bf.81e27","name":"ParseJson","property":"payload","action":"","pretty":false,"x":290,"y":100,"wires":[["499f4065.78aff8"]]},{"id":"228a87a4.a14cb","type":"mqtt out","z":"ccf231bf.81e27","name":"SendNotificationToClient","topic":"","qos":"","retain":"","broker":"2f173c3d.2232a4","x":1230,"y":460,"wires":[]},{"id":"313a1789.687c38","type":"function","z":"b990c6b5.7066a8","name":"ObjectToJSON","func":"return {\n    payload: JSON.stringify(msg.payload) + \"\\n\"\n};","outputs":1,"noerr":0,"x":1160,"y":340,"wires":[["ac0f0549.0d7be"]]},{"id":"b0e325ef.14d0b","type":"mqtt out","z":"6048f8e.4a8a188","name":"SendActionToStaff","topic":"MarketGo/staff/newAction","qos":"","retain":"","broker":"2f173c3d.2232a4","x":1150,"y":500,"wires":[]},{"id":"c0268d1f.3bac48","type":"mqtt out","z":"cdaf015f.da6f9","name":"SendActionToStaff","topic":"MarketGo/staff/newAction","qos":"","retain":"","broker":"2f173c3d.2232a4","x":739,"y":325,"wires":[]},{"id":"588ba2b6.c06b2c","type":"mqtt in","z":"6048f8e.4a8a188","name":"ReceiveShelfEvent","topic":"MarketGo/shelves","qos":"2","broker":"2f173c3d.2232a4","x":110,"y":40,"wires":[["5333b9a7.c954c"]]},{"id":"d2a56bfb.ee241","type":"function","z":"89d4ce43.452ce8","name":"SetContextAndPrepareQuery","func":"// expectedPayload = {idx -> quantity}\n\nmsg.cartData = msg.payload.cartData;\n\nvar productIdxs = \n    Object.keys(msg.payload.cartData)\n        .map((idx) => parseInt(idx));\n\nmsg.payload = {\n    idx: productIdxs,\n    multiple: true\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":220,"wires":[["57f97b1f.80ed2c"]]},{"id":"389d13a5.9e12f4","type":"function","z":"89d4ce43.452ce8","name":"CountTotal","func":"var total = 0;\nvar list = [];\n\nif(msg.payload.productData) {\n    msg.payload.productData.forEach((product) => {\n        var prodCount = msg.cartData[product.idx];\n        var subTotal = product.price * prodCount;\n        \n        var prodData = {\n            name: product.name,\n            quantity: prodCount,\n            subTotal: subTotal\n        }\n        \n        total += subTotal;\n        list.push(prodData);\n    });\n}\n\nmsg.payload = {\n    type: 'cartTotal',\n    total: total,\n    list: list\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":120,"wires":[[]]},{"id":"57f97b1f.80ed2c","type":"subflow:d1064383.99592","z":"89d4ce43.452ce8","name":"","x":830,"y":300,"wires":[["389d13a5.9e12f4"]]},{"id":"aba3b89b.fca0c","type":"subflow:89d4ce43.452ce8","z":"b990c6b5.7066a8","name":"","x":730,"y":280,"wires":[["20ca43cd.024e74"]]},{"id":"1bd1ca5d.32251e","type":"function","z":"89d4ce43.452ce8","name":"ParseResponse","func":"msg.cartEmpty = \n    Object.keys(msg.payload.cartData)\n        .length === 0;\n\nreturn msg;","outputs":1,"noerr":0,"x":180,"y":120,"wires":[["56f060e6.51b25"]]},{"id":"56f060e6.51b25","type":"switch","z":"89d4ce43.452ce8","name":"CartEmpty","property":"cartEmpty","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":140,"wires":[["31542fa5.1a173"],["d2a56bfb.ee241"]]},{"id":"31542fa5.1a173","type":"function","z":"89d4ce43.452ce8","name":"SetEmptyCart","func":"msg.payload = [];\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":80,"wires":[["389d13a5.9e12f4"]]},{"id":"fd14dd4.21a5b2","type":"function","z":"fd41aaa7.f153","name":"CompareAllergies","func":"var allergies = \n    msg.payload.allergies\n        .map(allergy => \n            allergy.toLowerCase()\n        );\n\nvar allergens = \n    msg.allergens\n        .map(allergen => \n            allergen.toLowerCase()\n        );\n\nvar warnings = [];\n\nallergies.forEach((allergy) => {\n    if(allergens.includes(allergy)) {\n        warnings.push('It contains ' + allergy);\n    } \n});\n\nmsg.warnings = warnings;\n\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":80,"wires":[[]]},{"id":"ba58e9de.83e388","type":"function","z":"d1064383.99592","name":"PrepareResponse","func":"var productData = msg.payload;\n\nmsg.payload = {\n    productData: productData,\n    warnings: msg.warnings\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":160,"wires":[[]]},{"id":"d031518d.b5175","type":"function","z":"d1064383.99592","name":"SetContext","func":"msg.clientIdx = msg.payload.clientIdx;\n\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":100,"wires":[["e0223fa6.846358"]]},{"id":"b8850717.41e658","type":"function","z":"fd41aaa7.f153","name":"SetContextAndPrepareQuery","func":"msg.allergens = msg.payload.allergens;\n\nmsg.payload = {\n    idx: msg.payload.clientIdx\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["d3272bd3.079b78"]]},{"id":"d3272bd3.079b78","type":"subflow:7aa22b9c.ee2e24","z":"fd41aaa7.f153","name":"","x":530,"y":80,"wires":[["fd14dd4.21a5b2"]]},{"id":"6b16bc2f.5db2fc","type":"subflow:9795499c.56c298","z":"b990c6b5.7066a8","x":730,"y":360,"wires":[["20ca43cd.024e74"]]},{"id":"81c82aa0.a6b218","type":"function","z":"9795499c.56c298","name":"ExtractDataAndPrepareSplit","func":"msg.data = msg.payload.data;\n\nmsg.payload = {\n    getCreditCardNumber: [\n        {\n            idx: msg.data.clientIdx\n        },\n        {\n            _id: 0,\n            creditCardNumber: 1\n        }\n    ],\n    getTotalCount: {\n        cartData: msg.data.cartData\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":40,"wires":[["c2e0899f.0b6278"]]},{"id":"5f7a72ac.6e2fd4","type":"tcp request","z":"9795499c.56c298","server":"127.0.0.1","port":"1500","out":"time","splitc":"0","name":"RequestPaymentToServer","x":680,"y":280,"wires":[["e660edd0.e673d8"]]},{"id":"44289a75.c5fffc","type":"json","z":"9795499c.56c298","name":"Jsonify","property":"payload","action":"str","pretty":false,"x":160,"y":280,"wires":[["a636e106.75593"]]},{"id":"911fe093.5e8e4","type":"tcp in","z":"e79ea024.5ddb1","name":"","server":"server","host":"","port":"1500","datamode":"stream","datatype":"utf8","newline":"\\n","topic":"ReceivePaymentData","base64":false,"x":100,"y":40,"wires":[["2fb5df72.17b71"]]},{"id":"8e02db14.4153c8","type":"tcp out","z":"e79ea024.5ddb1","host":"","port":"","beserver":"reply","base64":false,"end":false,"name":"","x":1090,"y":400,"wires":[]},{"id":"a636e106.75593","type":"encrypt","z":"9795499c.56c298","name":"Encrypt","algorithm":"AES","key":"bhaHswvPJHd6mFp+QDdXXg3pgjO+YlyJabEP1+1cHeU=","x":300,"y":280,"wires":[["6ea07511.e355a4"]]},{"id":"2fb5df72.17b71","type":"decrypt","z":"e79ea024.5ddb1","name":"Decrypt","algorithm":"AES","key":"bhaHswvPJHd6mFp+QDdXXg3pgjO+YlyJabEP1+1cHeU=","x":200,"y":100,"wires":[["f4d6d86c.7d735"]]},{"id":"6ea07511.e355a4","type":"function","z":"9795499c.56c298","name":"FixTcpRequest","func":"msg.payload += \"\\n\";\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":280,"wires":[["5f7a72ac.6e2fd4"]]},{"id":"f4d6d86c.7d735","type":"json","z":"e79ea024.5ddb1","name":"ParseJSON","property":"payload","action":"","pretty":false,"x":310,"y":160,"wires":[["7b75921f.9b7ad4"]]},{"id":"c2e0899f.0b6278","type":"split","z":"9795499c.56c298","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":250,"y":140,"wires":[["be46f5d5.4b4d78"]]},{"id":"be46f5d5.4b4d78","type":"switch","z":"9795499c.56c298","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"getCreditCardNumber","vt":"str"},{"t":"eq","v":"getTotalCount","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":140,"wires":[["da77cb77.388c2"],["a5adc73e.0aa8"]]},{"id":"a7585418.2888d","type":"function","z":"9795499c.56c298","name":"ExtractCreditCardNumber","func":"msg.payload = msg.payload.creditCardNumber;\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":120,"wires":[["18acdbfb.3957d4"]]},{"id":"da77cb77.388c2","type":"mongodb2 in","z":"9795499c.56c298","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"GetClientData","collection":"clients","operation":"findOne","x":520,"y":120,"wires":[["a7585418.2888d"]]},{"id":"a5adc73e.0aa8","type":"subflow:89d4ce43.452ce8","z":"9795499c.56c298","name":"","x":510,"y":160,"wires":[["4e23db19.c9be54"]]},{"id":"4e23db19.c9be54","type":"function","z":"9795499c.56c298","name":"SetContextAndExtractTotal","func":"msg.cartTotal = msg.payload;\n\nmsg.payload = msg.payload.total;\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":160,"wires":[["18acdbfb.3957d4"]]},{"id":"18acdbfb.3957d4","type":"join","z":"9795499c.56c298","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":950,"y":140,"wires":[["f68d4af3.10e5"]]},{"id":"f68d4af3.10e5","type":"function","z":"9795499c.56c298","name":"PrepareTCPPaymentMsg","func":"msg.payload = {\n    clientIdx: msg.data.clientIdx,\n    creditCardNumber: msg.payload.getCreditCardNumber,\n    totalCount: msg.payload.getTotalCount\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1130,"y":140,"wires":[["44289a75.c5fffc"]]},{"id":"7b75921f.9b7ad4","type":"function","z":"e79ea024.5ddb1","name":"PaymentMock","func":"//Fake payment allowing\nvar acceptedPayment = \n    msg.payload.creditCardNumber.length > 0 &&\n    Math.random() >= 0.3;\n\nmsg.payload = {\n    accepted: acceptedPayment\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":220,"wires":[["793d7a1f.286de4"]]},{"id":"793d7a1f.286de4","type":"json","z":"e79ea024.5ddb1","name":"Jsonify","property":"payload","action":"str","pretty":false,"x":560,"y":280,"wires":[["6a25ab3b.01964c"]]},{"id":"6a25ab3b.01964c","type":"function","z":"e79ea024.5ddb1","name":"FixTcpResponse","func":"msg.payload += \"\\n\";\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":340,"wires":[["5cb0d868.71b0a8"]]},{"id":"e660edd0.e673d8","type":"function","z":"9795499c.56c298","name":"ParseResponse","func":"msg.payload = msg.payload.toString();\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":280,"wires":[["40209382.45b8c4"]]},{"id":"1ce4b725.195e31","type":"switch","z":"9795499c.56c298","name":"PaymentSuccess","property":"payload.accepted","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":330,"y":420,"wires":[["9eb5fe86.2c41a8","d6faa5cd.6d616","c983f1e.8ffac9","251295b6.213fa2"],["885b1109.8994c8"]]},{"id":"5cb0d868.71b0a8","type":"encrypt","z":"e79ea024.5ddb1","name":"Encrypt","algorithm":"AES","key":"bhaHswvPJHd6mFp+QDdXXg3pgjO+YlyJabEP1+1cHeU=","x":880,"y":400,"wires":[["8e02db14.4153c8"]]},{"id":"40209382.45b8c4","type":"decrypt","z":"9795499c.56c298","name":"Decrypt","algorithm":"AES","key":"bhaHswvPJHd6mFp+QDdXXg3pgjO+YlyJabEP1+1cHeU=","x":1060,"y":280,"wires":[["295fdd5a.de7d22"]]},{"id":"295fdd5a.de7d22","type":"json","z":"9795499c.56c298","name":"ParseJSON","property":"payload","action":"obj","pretty":false,"x":150,"y":420,"wires":[["1ce4b725.195e31"]]},{"id":"4d59a591.b8ee1c","type":"function","z":"98cc4982.4a2d68","name":"SetContextAndPrepareQuery","func":"msg.payload = [\n    {\n        idx: msg.data.clientIdx\n    },\n    {\n        _id: 0,\n        email: 1\n    }\n]\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":100,"wires":[["51cf0668.fe98c8"]]},{"id":"51cf0668.fe98c8","type":"mongodb2 in","z":"98cc4982.4a2d68","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"GetClientData","collection":"clients","operation":"findOne","x":460,"y":100,"wires":[["ac7c74a5.754fe"]]},{"id":"c00413f6.39102","type":"e-mail","z":"98cc4982.4a2d68","server":"smtp.gmail.com","port":"465","secure":true,"name":"","dname":"SendEmailToClient","x":1170,"y":100,"wires":[]},{"id":"251295b6.213fa2","type":"subflow:98cc4982.4a2d68","z":"9795499c.56c298","x":740,"y":380,"wires":[]},{"id":"9eb5fe86.2c41a8","type":"function","z":"9795499c.56c298","name":"PrepareSuccessResponse","func":"var response = 'We sent you ' + \n    'an email with full details. ';\n\nmsg.payload = {\n    notification: {\n        type: 'message',\n        title: 'Payment OK',\n        data: response\n    },\n    success: true\n}\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":520,"wires":[[]]},{"id":"6f05038e.75d9d4","type":"template","z":"98cc4982.4a2d68","name":"SetEmailTemplate","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<h2>Thanks for your purchase!</h2>\n<h3>Your total: {{cartTotal.total}}</h3>\n<p>List:</p>\n<ul>\n    {{#cartTotal.list}}\n    <li>\n        <p>\n            <span style=\"color:red\">x{{quantity}}</span> \n            {{name}} ({{subTotal}})\n        </p>\n    </li>\n    {{/cartTotal.list}}\n</ul>","output":"str","x":930,"y":100,"wires":[["c00413f6.39102"]]},{"id":"ac7c74a5.754fe","type":"function","z":"98cc4982.4a2d68","name":"PrepareEmailHeader","func":"msg.topic = 'MarketGo purchase';\nmsg.to = msg.payload.email;\n\nmsg.payload = '';\n\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":100,"wires":[["6f05038e.75d9d4"]]},{"id":"499f4065.78aff8","type":"function","z":"ccf231bf.81e27","name":"SetContextAndPrepareGetOperation","func":"flow.set('clientIdx', msg.payload.clientIdx);\n\nmsg.payload = {\n    idx: msg.payload.productIdx\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":160,"wires":[["b6324383.19bc08"]]},{"id":"b6324383.19bc08","type":"subflow:d1064383.99592","z":"ccf231bf.81e27","name":"","x":670,"y":220,"wires":[["8a6abf62.806f98"]]},{"id":"13f0e834.4eabd8","type":"subflow:fd41aaa7.f153","z":"ccf231bf.81e27","x":1020,"y":340,"wires":[["38e246e9.282582"]]},{"id":"8a6abf62.806f98","type":"function","z":"ccf231bf.81e27","name":"SetContextAndPrepareCheckAllergies","func":"msg.productData = msg.payload.productData;\n\nmsg.payload = {\n    clientIdx: flow.get('clientIdx'),\n    allergens: msg.productData.data.allergens\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":280,"wires":[["13f0e834.4eabd8"]]},{"id":"38e246e9.282582","type":"function","z":"ccf231bf.81e27","name":"PrepareResponse","func":"var clientMsg = 'Added ' + \n    msg.productData.name + ' to cart';\n\nmsg.payload = {\n    product: msg.productData,\n    notification: {\n        type: 'message',\n        data: clientMsg,\n        warnings: msg.warnings\n    }\n}\n\nmsg.topic = 'MarketGo/clients/' + \n    flow.get('clientIdx') + '/productAdded';\n\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":400,"wires":[["228a87a4.a14cb"]]},{"id":"885b1109.8994c8","type":"function","z":"9795499c.56c298","name":"PrepareFailResponse","func":"var response = 'We are sorry, your payment ' + \n    'request was declined. Try again later';\n\nmsg.payload = {\n    notification: {\n        type: 'message',\n        title: 'Payment FAIL',\n        data: response\n    },\n    success: false\n}\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":580,"wires":[[]]},{"id":"5cb818e4.9dbbb","type":"mqtt out","z":"6048f8e.4a8a188","name":"","topic":"MarketGo/dashboard/shelves","qos":"2","retain":"","broker":"2f173c3d.2232a4","x":1070,"y":180,"wires":[]},{"id":"9d8cd9fc.96ef78","type":"function","z":"6048f8e.4a8a188","name":"PrepareDashboardUpdate","func":"msg.payload = {\n    idx: msg.payload.idx,\n    value: msg.actualQuantity\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":180,"wires":[["5cb818e4.9dbbb"]]},{"id":"4cfe2673.be8ec8","type":"mqtt in","z":"ad459c75.a2d28","name":"ShelvesUpdate","topic":"MarketGo/dashboard/shelves","qos":"2","broker":"2f173c3d.2232a4","x":180,"y":100,"wires":[["292c45fe.c70912"]]},{"id":"7b085131.61b128","type":"function","z":"ad459c75.a2d28","name":"SetShelfData","func":"msg.idx = msg.payload.idx;\n\nmsg.payload = msg.payload.value;\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":100,"wires":[["1adea8d2.33e9ff"]]},{"id":"292c45fe.c70912","type":"json","z":"ad459c75.a2d28","name":"","property":"payload","action":"","pretty":false,"x":370,"y":100,"wires":[["7b085131.61b128"]]},{"id":"9051b7ae.b70f4","type":"ui_gauge","z":"ad459c75.a2d28","name":"Shelf0","group":"98a7c04b.8378e8","order":0,"width":"0","height":"0","gtype":"donut","title":"Shelf 0 quantity","label":"products","format":"{{value}}","min":0,"max":"6","colors":["#2b7ed5","#2b7ed5","#2b7ed5"],"seg1":"","seg2":"","x":990,"y":60,"wires":[]},{"id":"1adea8d2.33e9ff","type":"switch","z":"ad459c75.a2d28","name":"CheckShelfIdx","property":"idx","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"2","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":760,"y":100,"wires":[["9051b7ae.b70f4"],["dafe10cc.abb2c8"],["f1ae1d2c.9e7f7"]]},{"id":"dafe10cc.abb2c8","type":"ui_gauge","z":"ad459c75.a2d28","name":"Shelf1","group":"98a7c04b.8378e8","order":0,"width":"0","height":"0","gtype":"donut","title":"Shelf 1 quantity","label":"products","format":"{{value}}","min":0,"max":"6","colors":["#2b7ed5","#2b7ed5","#2b7ed5"],"seg1":"","seg2":"","x":990,"y":100,"wires":[]},{"id":"f1ae1d2c.9e7f7","type":"ui_gauge","z":"ad459c75.a2d28","name":"Shelf2","group":"98a7c04b.8378e8","order":0,"width":"0","height":"0","gtype":"donut","title":"Shelf 2 quantity","label":"products","format":"{{value}}","min":0,"max":"6","colors":["#2b7ed5","#2b7ed5","#2b7ed5"],"seg1":"","seg2":"","x":990,"y":140,"wires":[]},{"id":"e7a41652.78666","type":"inject","z":"ad459c75.a2d28","name":"","topic":"","payload":"","payloadType":"date","repeat":"5","crontab":"","once":true,"onceDelay":"4","x":110,"y":320,"wires":[["32efb9a0.713656"]]},{"id":"dd354490.07216","type":"ui_chart","z":"ad459c75.a2d28","name":"Employee0Actions","group":"b3f7624a.893288","order":0,"width":0,"height":0,"label":"Employee (idx: 0) actions","chartType":"horizontalBar","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":1130,"y":240,"wires":[[],[]]},{"id":"5bbeedb6.be5164","type":"mongodb2 in","z":"ad459c75.a2d28","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"GetEmployeesData","collection":"employees","operation":"find.toArray","x":490,"y":280,"wires":[["8c28313e.087d18"]]},{"id":"32efb9a0.713656","type":"function","z":"ad459c75.a2d28","name":"PrepareFindQuery","func":"msg.payload = [\n    {},\n    {_id: 0, idx: 1, completedActions: 1}\n]\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":280,"wires":[["5bbeedb6.be5164"]]},{"id":"8c28313e.087d18","type":"function","z":"ad459c75.a2d28","name":"PrepareChartsData","func":"var employees = msg.payload\n    .sort((e1, e2) => e1.idx > e2.idx);\n\nvar max = 2;\nmsg.payload = {};\n\nemployees.forEach((employee) => {\n    var helpClientCount = 0;\n    var restockCount = 0;\n    \n    employee.completedActions.forEach((action) => {\n        if(action.type === 'help_client') {\n            helpClientCount += 1;\n        } else {\n            restockCount += 1;\n        }\n    });\n    \n    if(max < helpClientCount) {\n        max = helpClientCount;\n    }\n    \n    if(max < restockCount ) {\n        max = restockCount;\n    }\n    \n    msg.payload[employee.idx] = [{\n        series: [\"0\"],\n        data: [[helpClientCount, restockCount]],\n        labels: [\"help client\", \"restock\"]\n    }];\n});\n\nmax = Math.floor(max * 1.5);\n\nfor (var idx in msg.payload) {\n    msg.payload[idx][0].data[0].push(max);\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":280,"wires":[["26932da9.75e15a"]]},{"id":"4dea12fb.543054","type":"ui_chart","z":"ad459c75.a2d28","name":"Employee1Actions","group":"b3f7624a.893288","order":0,"width":0,"height":0,"label":"Employee (idx: 1) actions","chartType":"horizontalBar","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":1130,"y":320,"wires":[[],[]]},{"id":"26932da9.75e15a","type":"split","z":"ad459c75.a2d28","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":850,"y":280,"wires":[["9f306834.0326"]]},{"id":"9f306834.0326","type":"switch","z":"ad459c75.a2d28","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":970,"y":280,"wires":[["dd354490.07216"],["4dea12fb.543054"]]},{"id":"d6faa5cd.6d616","type":"subflow:2e7efc7b.baa364","z":"9795499c.56c298","name":"","x":734,"y":427,"wires":[]},{"id":"f0de4e67.789f7","type":"function","z":"2e7efc7b.baa364","name":"PreparePurchaseInsertion","func":"var clientIdx = msg.data.clientIdx;\nvar date = new Date();\nvar total = msg.cartTotal.total;\n\nvar list = [];\nfor(var idx in msg.cartData) {\n    list.push({\n       idx: idx,\n       quantity: msg.cartData[idx]\n    });\n}\n\nmsg.payload = {\n    clientIdx: clientIdx,\n    date: date,\n    total: total,\n    list: list\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["82978560.99458"]]},{"id":"82978560.99458","type":"mongodb2 in","z":"2e7efc7b.baa364","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"","collection":"purchases","operation":"insert","x":560,"y":80,"wires":[["4e200feb.980b5"]]},{"id":"c0007ac1.a799e","type":"inject","z":"ad459c75.a2d28","name":"","topic":"","payload":"","payloadType":"date","repeat":"5","crontab":"","once":true,"onceDelay":"4","x":110,"y":520,"wires":[["3d6220d5.9e8b3"]]},{"id":"3d6220d5.9e8b3","type":"function","z":"ad459c75.a2d28","name":"PrepareSplitAndQueries","func":"var today = new Date();\nvar lastWeekDay = new Date(\n        today.getFullYear(), \n        today.getMonth(), \n        today.getDate() - 6);\n\nmsg.payload = {\n    getPurchasesData: {\n        date: {\n            $gt: lastWeekDay\n        }\n    },\n    getProductIdxs: [\n        {}, \n        {_id: 0, idx: 1}  \n    ]\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":460,"wires":[["909898b.47267e8"]]},{"id":"909898b.47267e8","type":"split","z":"ad459c75.a2d28","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":370,"y":520,"wires":[["2bf2b3e7.71ecec"]]},{"id":"2bf2b3e7.71ecec","type":"switch","z":"ad459c75.a2d28","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"getPurchasesData","vt":"str"},{"t":"eq","v":"getProductIdxs","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":490,"y":520,"wires":[["1241aad.8be61d5"],["4fab9ebb.227e58"]]},{"id":"8135731d.3937","type":"join","z":"ad459c75.a2d28","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":850,"y":520,"wires":[["76b5939b.c8bb0c"]]},{"id":"1241aad.8be61d5","type":"mongodb2 in","z":"ad459c75.a2d28","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"GetPurchasesData","collection":"purchases","operation":"find.toArray","x":670,"y":480,"wires":[["8135731d.3937"]]},{"id":"4fab9ebb.227e58","type":"mongodb2 in","z":"ad459c75.a2d28","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"GetProductIdxsData","collection":"products","operation":"find.toArray","x":680,"y":540,"wires":[["8135731d.3937"]]},{"id":"76b5939b.c8bb0c","type":"function","z":"ad459c75.a2d28","name":"PrepareChartData","func":"var purchases = msg.payload.getPurchasesData;\nvar productIdxs = msg.payload.getProductIdxs\n    .map((prodData) => prodData.idx)\n    .sort((a,b) => a > b);\n\nvar result = {};\n\nproductIdxs.forEach(idx => \n    result[idx] = new Array(7).fill(0));\n\nvar thisDayNumber = new Date().getDay();\n\npurchases.forEach((purchase) => {\n    var day = purchase.date.getDay();\n    var index = (day + (6 - thisDayNumber)) % 7;\n    \n    purchase.list.forEach((product) => {\n        idx = product.idx;\n        quantity = product.quantity;\n        result[idx][index] += quantity;\n    });\n});\n\nvar graphData = {\n    series: [],\n    data: [],\n    labels: [-6,-5,-4,-3,-2,\"-1\",\"today\"]\n}\n\nfor (var idx in result) {\n    graphData.series.push(idx);\n    graphData.data.push(result[idx]);\n}\n\nmsg.payload = [graphData];\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":520,"wires":[["a103e8fd.9b7aa8"]]},{"id":"a103e8fd.9b7aa8","type":"ui_chart","z":"ad459c75.a2d28","name":"ProductSalesOverLastWeek","group":"cba27512.52587","order":1,"width":0,"height":0,"label":"Last week","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#10bf00","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":1200,"y":580,"wires":[[],[]]},{"id":"999d01c1.c9afb","type":"ui_text","z":"ad459c75.a2d28","group":"cba27512.52587","order":0,"width":0,"height":0,"name":"Product0Label","label":"","format":"- <font color='#1F77B4'>Peanut butter (idx: 0)</font>","layout":"row-left","x":1240,"y":440,"wires":[]},{"id":"5e103107.70fdc","type":"ui_text","z":"ad459c75.a2d28","group":"cba27512.52587","order":0,"width":0,"height":0,"name":"Product1Label","label":"","format":"- <font color='#10BF00'>Asiago DOP Cheese (idx: 1)</font>","layout":"row-left","x":1240,"y":480,"wires":[]},{"id":"de033431.9cbcf","type":"ui_text","z":"ad459c75.a2d28","group":"cba27512.52587","order":0,"width":0,"height":0,"name":"Product2Label","label":"","format":"- <font color='#FF7F0E'>Pizza (idx: 2)</font>","layout":"row-left","x":1240,"y":520,"wires":[]},{"id":"4259c4d3.9cf18c","type":"mqtt out","z":"ff8dca5f.92dd4","name":"UpdateDashboardStaffActions","topic":"MarketGo/dashboard/staffActions","qos":"","retain":"","broker":"2f173c3d.2232a4","x":970,"y":180,"wires":[]},{"id":"20826887.7a1fe","type":"mqtt in","z":"ad459c75.a2d28","name":"StaffActionsUpdate","topic":"MarketGo/dashboard/staffActions","qos":"2","broker":"2f173c3d.2232a4","x":110,"y":240,"wires":[["32efb9a0.713656"]]},{"id":"3ca6d587.463772","type":"mqtt in","z":"ad459c75.a2d28","name":"PurchasesUpdate","topic":"MarketGo/dashboard/purchasesUpdate","qos":"2","broker":"2f173c3d.2232a4","x":110,"y":400,"wires":[["3d6220d5.9e8b3"]]},{"id":"4e200feb.980b5","type":"mqtt out","z":"2e7efc7b.baa364","name":"DashboardPurchasesUpdate","topic":"MarketGo/dashboard/purchasesUpdate","qos":"","retain":"","broker":"2f173c3d.2232a4","x":900,"y":80,"wires":[]},{"id":"85782836.13b7a","type":"function","z":"73e3c04c.e444","name":"PrepareMessage","func":"msg.payload = {\n    notification: {\n        type: 'ratingRequest',\n        title: 'Rating request',\n        data: 'Rate your experience in MarketGo!'\n    }\n}\n\nvar clientIdx = msg.data.clientIdx;\n\nmsg.topic = 'MarketGo/clients/' + clientIdx + \n    '/ratingRequest';\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":60,"wires":[["bf600358.7270b"]]},{"id":"53f0832d.67e474","type":"mqtt out","z":"73e3c04c.e444","name":"SendRatingRequestToClient","topic":"","qos":"2","retain":"","broker":"2f173c3d.2232a4","x":720,"y":60,"wires":[]},{"id":"c983f1e.8ffac9","type":"subflow:73e3c04c.e444","z":"9795499c.56c298","x":740,"y":474,"wires":[]},{"id":"93b59c41.b45618","type":"mqtt in","z":"8814dea3.14c64","name":"ReceiveClientRating","topic":"MarketGo/client/ratingGiven","qos":"2","broker":"2f173c3d.2232a4","x":130,"y":60,"wires":[["7d7f2d20.3c0774"]]},{"id":"7d7f2d20.3c0774","type":"json","z":"8814dea3.14c64","name":"ParseJSON","property":"payload","action":"","pretty":false,"x":270,"y":120,"wires":[["166c6b55.76e3bd"]]},{"id":"3de09b1f.96e6c4","type":"function","z":"8814dea3.14c64","name":"PrepareForInsertion","func":"msg.payload = {\n    date: new Date(),\n    clientIdx: msg.payload.clientIdx,\n    value: parseInt(msg.payload.value)\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":860,"y":220,"wires":[["165e1481.fb1b73"]]},{"id":"165e1481.fb1b73","type":"mongodb2 in","z":"8814dea3.14c64","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"InsertRating","collection":"ratings","operation":"insert","x":950,"y":280,"wires":[["571754ec.d08604"]]},{"id":"3ff8ff55.d4ed9","type":"inject","z":"ad459c75.a2d28","name":"","topic":"","payload":"","payloadType":"date","repeat":"5","crontab":"","once":true,"onceDelay":"4","x":170,"y":700,"wires":[["2b97e70c.6bccf8"]]},{"id":"e88498b4.3f5f98","type":"ui_gauge","z":"ad459c75.a2d28","name":"ClientRatingsAvg","group":"f05cf87c.417ef","order":0,"width":0,"height":0,"gtype":"gage","title":"Average","label":"stars","format":"{{value}}","min":"1","max":"5","colors":["#ca3838","#e6e600","#00b500"],"seg1":"","seg2":"","x":990,"y":700,"wires":[]},{"id":"e77c17b6.5d1788","type":"function","z":"ad459c75.a2d28","name":"PrepareGaugeData","func":"var sum = 0;\n\nmsg.payload.forEach((rating) => \n    sum += parseInt(rating.value));\n\nmsg.payload = (sum / msg.payload.length)\n    .toFixed(2);\n    \nreturn msg;","outputs":1,"noerr":0,"x":760,"y":700,"wires":[["e88498b4.3f5f98"]]},{"id":"2b97e70c.6bccf8","type":"function","z":"ad459c75.a2d28","name":"PrepareFindQuery","func":"msg.payload = [\n    {},\n    {_id: 0, value: 1}\n]\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":700,"wires":[["25034c9a.df5a0c"]]},{"id":"25034c9a.df5a0c","type":"mongodb2 in","z":"ad459c75.a2d28","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"GetRatings","collection":"ratings","operation":"find.toArray","x":550,"y":700,"wires":[["e77c17b6.5d1788"]]},{"id":"c3c305c7.a937d","type":"mqtt in","z":"ad459c75.a2d28","name":"RatingsUpdate","topic":"MarketGo/dashboard/ratingsUpdate","qos":"2","broker":"2f173c3d.2232a4","x":160,"y":640,"wires":[["2b97e70c.6bccf8"]]},{"id":"571754ec.d08604","type":"mqtt out","z":"8814dea3.14c64","name":"DashboardUpdateRatings","topic":"MarketGo/dashboard/ratingsUpdate","qos":"2","retain":"","broker":"2f173c3d.2232a4","x":1180,"y":280,"wires":[]},{"id":"db9fa077.f1385","type":"mqtt out","z":"8814dea3.14c64","name":"SendRatingReceivedNotification","topic":"","qos":"2","retain":"","broker":"2f173c3d.2232a4","x":1130,"y":140,"wires":[]},{"id":"f9c07dae.75b34","type":"split","z":"8814dea3.14c64","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":530,"y":180,"wires":[["c839fba5.e14338"]]},{"id":"c839fba5.e14338","type":"switch","z":"8814dea3.14c64","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"notifyClient","vt":"str"},{"t":"eq","v":"saveRating","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":180,"wires":[["8841b102.af7fb8"],["3de09b1f.96e6c4"]]},{"id":"166c6b55.76e3bd","type":"function","z":"8814dea3.14c64","name":"PrepareSplit","func":"msg.payload = {\n    saveRating: {\n        date: new Date(),\n        clientIdx: msg.payload.clientIdx,\n        value: parseInt(msg.payload.value)\n    },\n    notifyClient: {\n        clientIdx: msg.payload.clientIdx\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":180,"wires":[["f9c07dae.75b34"]]},{"id":"8841b102.af7fb8","type":"function","z":"8814dea3.14c64","name":"PrepareClientNotification","func":"msg.topic = 'MarketGo/clients/' + \n    msg.payload.clientIdx + '/ratingReceived'\n\nmsg.payload = {\n    notification: {\n        type: 'message',\n        title: 'Rating received',\n        data: 'Thanks for your rating!'\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":140,"wires":[["db9fa077.f1385"]]},{"id":"7685d062.0bc168","type":"switch","z":"6048f8e.4a8a188","name":"CheckQuantityDecreasing","property":"oldQuantity","propertyType":"msg","rules":[{"t":"gt","v":"actualQuantity","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":720,"y":320,"wires":[["bef6a133.e58398"]]},{"id":"31c081f.70914fe","type":"subflow:809e0a56.47445","z":"b990c6b5.7066a8","x":730,"y":220,"wires":[["20ca43cd.024e74"]]},{"id":"4354d30e.6db97c","type":"function","z":"809e0a56.47445","name":"SetContextAndPrepareProductInformationRequest","func":"flow.set('clientIdx', msg.payload.clientIdx);\n\ndelete msg.payload.clientIdx;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":80,"wires":[["7b85d797.745ca"]]},{"id":"7b85d797.745ca","type":"subflow:d1064383.99592","z":"809e0a56.47445","x":510,"y":140,"wires":[["7e86e045.49d708"]]},{"id":"e3e6256.97855d8","type":"subflow:fd41aaa7.f153","z":"809e0a56.47445","name":"","x":880,"y":260,"wires":[["dba6fce0.71ea88"]]},{"id":"7e86e045.49d708","type":"function","z":"809e0a56.47445","name":"SetContextAndPrepareCheckAllergies","func":"flow.set('productData', msg.payload.productData);\n\nmsg.payload = {\n    clientIdx: flow.get('clientIdx'),\n    allergens:  \n        msg.payload.productData.data.allergens\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":200,"wires":[["e3e6256.97855d8"]]},{"id":"dba6fce0.71ea88","type":"function","z":"809e0a56.47445","name":"PrepareResponse","func":"msg.payload = {\n    notification: {\n        type: 'productInformation',\n        data: flow.get('productData'),\n        warnings: msg.warnings    \n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":320,"wires":[[]]},{"id":"bf600358.7270b","type":"delay","z":"73e3c04c.e444","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":480,"y":60,"wires":[["53f0832d.67e474"]]},{"id":"718ec499.f6b9ac","type":"function","z":"4b78a9ba.a4721","name":"PrepareQuery","func":"msg.payload = [\n    {\n        idx: msg.payload.idx\n    },\n    {\n        _id: 0\n    }\n]\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":80,"wires":[["86d35ade.029c38"]]},{"id":"86d35ade.029c38","type":"mongodb2 in","z":"4b78a9ba.a4721","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"GetClientData","collection":"clients","operation":"findOne","x":460,"y":80,"wires":[[]]},{"id":"451fddcd.9e016c","type":"subflow:4b78a9ba.a4721","z":"b990c6b5.7066a8","x":740,"y":440,"wires":[["20ca43cd.024e74"]]},{"id":"837af942.a504d8","type":"subflow:31a2f90.b455288","z":"9795499c.56c298","x":240,"y":40,"wires":[["c238eabe.732308"]]},{"id":"c238eabe.732308","type":"switch","z":"9795499c.56c298","name":"SignatureValid","property":"signatureValid","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":460,"y":40,"wires":[["81c82aa0.a6b218"],["885b1109.8994c8"]]},{"id":"ba9bd4b2.dd9f3","type":"function","z":"31a2f90.b455288","name":"SetContextAndPrepareQuery","func":"msg.data = msg.payload.data;\nmsg.payload = [\n    {idx: msg.data.clientIdx},\n    {_id: 0, publicKey: 1}\n]\n\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":80,"wires":[["b69c503c.3b26"]]},{"id":"b69c503c.3b26","type":"mongodb2 in","z":"31a2f90.b455288","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"GetClientData","collection":"clients","operation":"findOne","x":500,"y":80,"wires":[["3f9d4d3a.c95e6a"]]},{"id":"3f9d4d3a.c95e6a","type":"function","z":"31a2f90.b455288","name":"VerifySignature","func":"var verifySignature = global.get('verifySignature');\n\nmsg.signatureValid = verifySignature(\n    msg.payload.publicKey,\n    msg.data.signature,\n    'base64'\n);\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":80,"wires":[["f6c3cd9e.926d8"]]},{"id":"f6c3cd9e.926d8","type":"function","z":"31a2f90.b455288","name":"ResetContext","func":"msg.payload.data = msg.data;\n\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":80,"wires":[[]]},{"id":"3940178c.414ac8","type":"mqtt in","z":"fe000750.43aec8","name":"ReceiveProductRemovedEvent","topic":"MarketGo/carts/productRemoved","qos":"2","broker":"2f173c3d.2232a4","x":180,"y":80,"wires":[["6ca6556e.daf79c"]]},{"id":"14325279.fb882e","type":"mqtt out","z":"fe000750.43aec8","name":"SendNotificationToClient","topic":"","qos":"","retain":"","broker":"2f173c3d.2232a4","x":1210,"y":400,"wires":[]},{"id":"443b548e.60cf1c","type":"function","z":"fe000750.43aec8","name":"ExtractDataAndPrepareNotification","func":"let clientIdx = flow.get('clientIdx');\nlet product = msg.payload.productData;\n\nmsg.payload = {\n    productIdx: product.idx,\n    notification: {\n        type: 'message',\n        data: 'Removed ' + product.name + \n            ' from your cart'\n    }\n}\n\nmsg.topic = 'MarketGo/clients/' + clientIdx + \n    '/productRemoved';\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":320,"wires":[["14325279.fb882e"]]},{"id":"6ca6556e.daf79c","type":"json","z":"fe000750.43aec8","name":"ParseJson","property":"payload","action":"","pretty":false,"x":370,"y":140,"wires":[["e254c1ab.05138"]]},{"id":"af22286.dd75b58","type":"subflow:d1064383.99592","z":"fe000750.43aec8","name":"","x":800,"y":260,"wires":[["443b548e.60cf1c"]]},{"id":"e254c1ab.05138","type":"function","z":"fe000750.43aec8","name":"SetContextAndPrepareGetOperation","func":"flow.set('clientIdx', msg.payload.clientIdx);\n\nmsg.payload = {\n    idx: msg.payload.productIdx\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":200,"wires":[["af22286.dd75b58"]]}]