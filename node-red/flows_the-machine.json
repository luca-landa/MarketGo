[{"id":"6048f8e.4a8a188","type":"tab","label":"ShelfStatusUpdate","disabled":false,"info":"Receives shelf status update, and if it needs restock sends an action to staff"},{"id":"ff8dca5f.92dd4","type":"tab","label":"StaffPalmarsActionCompletion","disabled":false,"info":"Handles \"action complete\" notifications from staff palmars"},{"id":"cdaf015f.da6f9","type":"tab","label":"ClientHelpRequest","disabled":false,"info":"Receive client help request and send notification \nto staff"},{"id":"846cb802.b3c298","type":"tab","label":"GetProductInformation","disabled":false,"info":"Receives product information request and sends it back via tcp"},{"id":"b84a635a.4d144","type":"subflow","name":"TestShelfFlow","info":"","in":[{"x":50,"y":30,"wires":[{"id":"a8b544fb.306bf8"}]}],"out":[]},{"id":"78e5f54c.69e074","type":"subflow","name":"UpdateShelfQuantity","info":"update shelf status","in":[{"x":50,"y":30,"wires":[{"id":"dd722615.0892e"}]}],"out":[]},{"id":"23bdf2dc.733276","type":"subflow","name":"SendNewActionToStaff","info":"Sends a new action notification to staff palmars","in":[{"x":50,"y":30,"wires":[{"id":"c55890d3.95081"}]}],"out":[]},{"id":"2f173c3d.2232a4","type":"mqtt-broker","z":"","name":"LocalMQTTBroker","broker":"localhost","port":"1883","tls":"","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willPayload":"","birthTopic":"","birthQos":"0","birthPayload":""},{"id":"b1b3643e.1e1e58","type":"mongodb2","z":"","uri":"mongodb://localhost:27017/MarketGo","name":"MarketGo","options":"","parallelism":"-1"},{"id":"588ba2b6.c06b2c","type":"mqtt in","z":"6048f8e.4a8a188","name":"ReceiveShelfEvent","topic":"MarketGo/shelves","qos":"2","broker":"2f173c3d.2232a4","x":110,"y":40,"wires":[["5333b9a7.c954c"]]},{"id":"37662d4a.52630a","type":"function","z":"6048f8e.4a8a188","name":"ExtractQuantityParams","func":"var shelf = msg.payload;\nmsg.payload = {\n    idx: shelf.idx,\n    quantity: flow.get('actualQuantity'),\n    minimumQuantity: shelf.minimumQuantity\n} \n    \nreturn msg;","outputs":1,"noerr":0,"x":690,"y":320,"wires":[["bef6a133.e58398"]]},{"id":"5333b9a7.c954c","type":"json","z":"6048f8e.4a8a188","name":"ParseJSON","property":"payload","action":"","pretty":false,"x":230,"y":100,"wires":[["371b506b.e5971"]]},{"id":"bef6a133.e58398","type":"switch","z":"6048f8e.4a8a188","name":"CheckQuantity","property":"payload.quantity","propertyType":"msg","rules":[{"t":"lt","v":"payload.minimumQuantity","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":860,"y":400,"wires":[["54da7586.1da9e4"]]},{"id":"371b506b.e5971","type":"function","z":"6048f8e.4a8a188","name":"SetContextAndPrepareQuery","func":"flow.set('actualQuantity', msg.payload.quantity);\nreturn {\n    payload: {\n        idx: msg.payload.idx\n    }\n};","outputs":1,"noerr":0,"x":390,"y":160,"wires":[["de33e5a.25e8b98"]]},{"id":"5f6cd545.064cdc","type":"mqtt out","z":"b84a635a.4d144","name":"SendShelfQuantity","topic":"MarketGo/shelves","qos":"","retain":"","broker":"2f173c3d.2232a4","x":630,"y":40,"wires":[]},{"id":"a8b544fb.306bf8","type":"function","z":"b84a635a.4d144","name":"TestSendShelfQuantity","func":"msg.payload = {\n    idx: 0,\n    quantity: 3\n}\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":40,"wires":[["5f6cd545.064cdc"]]},{"id":"de33e5a.25e8b98","type":"mongodb2 in","z":"6048f8e.4a8a188","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"GetShelfData","collection":"shelves","operation":"findOne","x":560,"y":240,"wires":[["37662d4a.52630a"]]},{"id":"72961133.1e9038","type":"mongodb2 in","z":"78e5f54c.69e074","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"UpdateShelf","collection":"shelves","operation":"update","x":590,"y":80,"wires":[[]]},{"id":"dd722615.0892e","type":"function","z":"78e5f54c.69e074","name":"PrepareUpdateQuery","func":"return {\n    payload: [{\n        idx: msg.payload.idx\n    }, {\n        $set: {\n            quantity: msg.payload.quantity   \n        }\n    }]\n};","outputs":1,"noerr":0,"x":280,"y":60,"wires":[["72961133.1e9038"]]},{"id":"54da7586.1da9e4","type":"function","z":"6048f8e.4a8a188","name":"CreateStaffAction","func":"msg.payload = {\n    action: 'restock',\n    idx: msg.payload.idx\n}\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":460,"wires":[["94ae3bbd.873fb"]]},{"id":"fcf4d94c.8f9d2","type":"mqtt in","z":"ff8dca5f.92dd4","name":"ReceiveStaffAction","topic":"MarketGo/staff/action/completed","qos":"2","broker":"2f173c3d.2232a4","x":130,"y":60,"wires":[["f8eae27.c7db9a"]]},{"id":"f8eae27.c7db9a","type":"json","z":"ff8dca5f.92dd4","name":"ParseJSON","property":"payload","action":"","pretty":false,"x":290,"y":120,"wires":[["d1117120.1b4998"]]},{"id":"d1117120.1b4998","type":"function","z":"ff8dca5f.92dd4","name":"StoreCompletedActionQuery","func":"var completedAction = msg.payload.action;\n\nflow.set('staffPalmarIdx', msg.payload.idx);\nflow.set('completedAction', completedAction);\n\nvar newActionRecord = {\n    action: completedAction,\n    timestamp: new Date().toString()    \n};\n\nreturn {\n    payload: [\n        { idx: msg.payload.idx },\n        { $push: { \n            completedActions: \n                newActionRecord\n            }\n        }\n    ]\n};","outputs":1,"noerr":0,"x":500,"y":180,"wires":[["58d969ef.83428"]]},{"id":"58d969ef.83428","type":"mongodb2 in","z":"ff8dca5f.92dd4","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"StoreAction","collection":"employees","operation":"update","x":690,"y":240,"wires":[["3ef8354a.a39a2a"]]},{"id":"3ef8354a.a39a2a","type":"function","z":"ff8dca5f.92dd4","name":"PrepareDeleteActionMsg","func":"return {\n    payload: {\n        notification: flow.get('completedAction')\n    }\n}","outputs":1,"noerr":0,"x":870,"y":300,"wires":[["9cf4ada.264b2d"]]},{"id":"9cf4ada.264b2d","type":"mqtt out","z":"ff8dca5f.92dd4","name":"UpdateStaffPalmars","topic":"MarketGo/staff/action/delete","qos":"2","retain":"","broker":"2f173c3d.2232a4","x":1080,"y":360,"wires":[]},{"id":"1903fe2c.dd6c0a","type":"subflow:b84a635a.4d144","z":"6048f8e.4a8a188","x":360,"y":600,"wires":[]},{"id":"25ee4fe6.b0ae4","type":"inject","z":"6048f8e.4a8a188","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":520,"wires":[["1903fe2c.dd6c0a"]]},{"id":"dd01cc13.7ae468","type":"mqtt in","z":"cdaf015f.da6f9","name":"ReceiveClientHelpRequest","topic":"MarketGo/client/action/help","qos":"2","broker":"2f173c3d.2232a4","x":190,"y":80,"wires":[["d1eb1a85.8fce2"]]},{"id":"d1eb1a85.8fce2","type":"json","z":"cdaf015f.da6f9","name":"ParseJSON","property":"payload","action":"","pretty":false,"x":350,"y":160,"wires":[["8a8d941d.491c68"]]},{"id":"c55890d3.95081","type":"mqtt out","z":"23bdf2dc.733276","name":"SendActionToStaff","topic":"MarketGo/staff/action/new","qos":"","retain":"","broker":"2f173c3d.2232a4","x":250,"y":100,"wires":[]},{"id":"94ae3bbd.873fb","type":"subflow:23bdf2dc.733276","z":"6048f8e.4a8a188","x":1220,"y":520,"wires":[]},{"id":"8a8d941d.491c68","type":"function","z":"cdaf015f.da6f9","name":"CreateStaffAction","func":"var clientName = msg.payload.name;\nvar clientIdx = msg.payload.idx;\n\nreturn {\n    payload: {\n        action: 'Help client \"' + clientName + '\"',\n        idx: clientIdx\n    }\n}","outputs":1,"noerr":0,"x":510,"y":240,"wires":[["4e53288a.ae318"]]},{"id":"4e53288a.ae318","type":"subflow:23bdf2dc.733276","z":"cdaf015f.da6f9","x":720,"y":320,"wires":[]},{"id":"1bd3f368.4c3b6d","type":"tcp in","z":"846cb802.b3c298","name":"ReceiveTCPRequest","server":"server","host":"","port":"1337","datamode":"stream","datatype":"utf8","newline":"\\n","topic":"","base64":false,"x":180,"y":140,"wires":[["77c41b82.dca84c"]]},{"id":"3a44f8f.8e6b808","type":"debug","z":"846cb802.b3c298","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":910,"y":240,"wires":[]},{"id":"77c41b82.dca84c","type":"json","z":"846cb802.b3c298","name":"ParseJSON","property":"payload","action":"","pretty":false,"x":270,"y":220,"wires":[["9c8c6b37.3c3508"]]},{"id":"9c8c6b37.3c3508","type":"switch","z":"846cb802.b3c298","name":"CheckRequestType","property":"event","propertyType":"msg","rules":[{"t":"eq","v":"productInformationRequest","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":400,"y":300,"wires":[["11b8d852.18643"]]},{"id":"11b8d852.18643","type":"function","z":"846cb802.b3c298","name":"PrepareFindProductQuery","func":"return {\n    payload: {\n        idx: msg.payload.idx\n    }\n};","outputs":1,"noerr":0,"x":480,"y":380,"wires":[["9f6136b2.31fb7"]]},{"id":"9f6136b2.31fb7","type":"mongodb2 in","z":"846cb802.b3c298","service":"_ext_","configNode":"b1b3643e.1e1e58","name":"FindProduct","collection":"products","operation":"findOne","x":630,"y":440,"wires":[["9ab2ae95.bf0878","3a44f8f.8e6b808"]]},{"id":"9ab2ae95.bf0878","type":"function","z":"846cb802.b3c298","name":"ExtractProductInformation","func":"var product = msg.payload;\n\nreturn {\n    name: product.name,\n    data: product.data\n}","outputs":1,"noerr":0,"x":820,"y":500,"wires":[["3060ef6f.f87338"]]},{"id":"3060ef6f.f87338","type":"tcp out","z":"846cb802.b3c298","host":"","port":"","beserver":"reply","base64":false,"end":false,"name":"SendProductInformation","x":1110,"y":500,"wires":[]}]